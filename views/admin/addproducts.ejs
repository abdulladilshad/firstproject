<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product</title>
    <link rel="stylesheet" href="/styles/addproducts.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>PRODUCTS</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="/admin/dashboard">
                        <i class="fas fa-home"></i> Dashboard
                    </a></li>
                <li><a href="/admin/products" class="active">
                        <i class="fas fa-box"></i> Products
                    </a></li>
                <li><a href="/orders">
                        <i class="fas fa-shopping-cart"></i> Orders
                    </a></li>
                <li><a href="/admin/users">
                        <i class="fas fa-users"></i> Users
                    </a></li>
                <li><a href="/admin/categories">
                        <i class="fas fa-tags"></i> Category
                    </a></li>
                <li><a href="/offers">
                        <i class="fas fa-gift"></i> Offers
                    </a></li>
                <li><a href="/coupons">
                        <i class="fas fa-ticket-alt"></i> Coupons
                    </a></li>
                <li><a href="/settings">
                        <i class="fas fa-cog"></i> Settings
                    </a></li>
                <li><a href="/logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a></li>
            </ul>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <h1>Add Product</h1>
            </header>
            <section class="add-product-form">
                <form id="productForm" action="/admin/addproducts" method="POST">
                    <!-- Product Name -->
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" name="productName">
                        <div class="error-message" id="productNameError" style="display:none; color: red;">Product name
                            is required</div>
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                            <% categories.forEach(category=> { %>
                                <option value="<%= category._id %>">
                                    <%= category?.name %>
                                </option>
                                <% }) %>
                        </select>
                        <div class="error-message" id="categoryError" style="display:none; color: red;">Category is
                            required</div>
                    </div>

                    <!-- Price -->
                    <div class="form-group">
                        <label for="price">Price ($)</label>
                        <input type="number" id="price" name="price">
                        <div class="error-message" id="priceError" style="display:none; color: red;">Price is required
                        </div>
                    </div>

                    <!-- Brand -->
                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" id="brand" name="brand">
                        <div class="error-message" id="brandError" style="display:none; color: red;">Brand is required
                        </div>
                    </div>

                    <!-- Stock -->
                    <div class="form-group">
                        <label for="stock">Stock</label>
                        <input type="number" id="stock" name="stock">
                        <div class="error-message" id="stockError" style="display:none; color: red;">Stock is required
                        </div>
                    </div>

                    <!-- Color -->
                    <div class="form-group">
                        <label for="color">Color</label>
                        <input type="text" id="color" name="color">
                        <div class="error-message" id="colorError" style="display:none; color: red;">Color is required
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="form-group">
                        <label for="material">Material</label>
                        <input type="text" id="material" name="material">
                        <div class="error-message" id="materialError" style="display:none; color: red;">Material is
                            required</div>
                    </div>

                    <!-- Product Description -->
                    <div class="form-group">
                        <label for="productDescription">Product Description</label>
                        <textarea id="productDescription" name="productDescription" rows="5"></textarea>
                        <div class="error-message" id="productDescriptionError" style="display:none; color: red;">
                            Description is required</div>
                    </div>

                    <!-- Product Images -->
                    <div style="margin: 2%;" class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-800">Product Images</h2>
                            <span class="text-sm text-gray-500">Upload up to 4 images</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <% for (let i=1; i <=4; i++) { %>
                                <div id="imageUploadSection<%= i %>" class="relative group">
                                    <!-- Upload Area -->
                                    <div
                                        class="min-h-[300px] bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 transition-all duration-300 hover:border-blue-500 hover:bg-gray-100">
                                        <label for="imageUpload<%= i %>" class="block h-full">
                                            <div
                                                class="flex flex-col items-center justify-center h-full space-y-4 cursor-pointer">
                                                <!-- Upload Icon -->
                                                <div
                                                    class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                </div>
                                                <!-- Upload Text -->
                                                <div class="text-center">
                                                    <p class="text-sm font-medium text-gray-700">Image <%= i %>
                                                    </p>
                                                    <p class="mt-1 text-xs text-gray-500">Drop your image here, or click
                                                        to browse</p>
                                                    <p class="mt-2 text-xs text-gray-400">PNG, JPG up to 5MB</p>
                                                    <!-- Image Cropper Container -->
                                                    <div style="height: 200px;"
                                                        class="relative w-full h-[300px] overflow-hidden border border-gray-300 rounded-lg">
                                                        <img id="cropperImage<%= i %>"
                                                            class="absolute inset-0 w-full h-full object-contain" src=""
                                                            style="display:none;">
                                                    </div>

                                                </div>
                                            </div>
                                        </label>
                                        <input type="file" id="imageUpload<%= i %>" accept="image/*" class="hidden">
                                    </div>





                                    <!-- Image Preview -->
                                    <div class="image-container mt-4">
                                        <img id="cropperImage<%= i %>"
                                            class="w-full rounded-lg shadow-md object-cover max-h-[300px]" src=""
                                            style="display:none;">
                                    </div>

                                    <!-- Cropped Preview -->
                                    <div id="previewContainer<%= i %>" class="mt-4 hidden">
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <h3 class="text-sm font-medium text-gray-700 mb-3">Preview</h3>
                                            <img id="croppedPreview<%= i %>"
                                                class="w-full rounded-lg shadow-sm object-cover max-h-[200px]">
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex items-center gap-3 mt-4">
                                        <button id="cropButton<%= i %>" type="button" disabled
                                            class="flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 
                                                       transition-colors disabled:opacity-50 disabled:cursor-not-allowed">

                                            Crop
                                        </button>
                                        <button id="resetButton<%= i %>" type="button" disabled
                                            class="flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 
                                                       transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                            Reset
                                        </button>
                                        <button id="deleteButton<%= i %>" type="button" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 
                                                       transition-colors hidden">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                            Delete
                                        </button>
                                    </div>

                                    <!-- Error Message -->
                                    <div id="imageError<%= i %>" class="hidden mt-2">
                                        <p class="text-sm text-red-500 flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            Image is required
                                        </p>
                                    </div>
                                </div>
                                <% } %>
                        </div>
                    </div>

                    <!-- Hidden Inputs for Base64 Images -->
                    <input type="hidden" id="image1" name="image1">
                    <input type="hidden" id="image2" name="image2">
                    <input type="hidden" id="image3" name="image3">
                    <input type="hidden" id="image4" name="image4">

                    <!-- Submit and Cancel Buttons -->
                    <div class="form-actions">
                        <button type="submit" class="submit-button">Add Product</button>
                        <button type="button" class="cancel-button" onclick="window.history.back()">Cancel</button>
                    </div>
                </form>


            </section>
        </main>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.16/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let croppers = [];
        let croppedImages = {};

        const imageUploads = [
            { upload: document.getElementById('imageUpload1'), image: document.getElementById('cropperImage1'), cropBtn: document.getElementById('cropButton1'), resetBtn: document.getElementById('resetButton1'), deleteBtn: document.getElementById('deleteButton1'), error: document.getElementById('imageError1') },
            { upload: document.getElementById('imageUpload2'), image: document.getElementById('cropperImage2'), cropBtn: document.getElementById('cropButton2'), resetBtn: document.getElementById('resetButton2'), deleteBtn: document.getElementById('deleteButton2'), error: document.getElementById('imageError2') },
            { upload: document.getElementById('imageUpload3'), image: document.getElementById('cropperImage3'), cropBtn: document.getElementById('cropButton3'), resetBtn: document.getElementById('resetButton3'), deleteBtn: document.getElementById('deleteButton3'), error: document.getElementById('imageError3') },
            { upload: document.getElementById('imageUpload4'), image: document.getElementById('cropperImage4'), cropBtn: document.getElementById('cropButton4'), resetBtn: document.getElementById('resetButton4'), deleteBtn: document.getElementById('deleteButton4'), error: document.getElementById('imageError4') },
        ];

        imageUploads.forEach((item, index) => {
            item.upload.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) {
                    item.error.textContent = "Image is required";
                    item.error.style.display = 'block';
                    return;
                }
                const reader = new FileReader();

                reader.onload = function (event) {
                    item.image.src = event.target.result;
                    item.image.style.display = 'block';

                    if (croppers[index]) {
                        croppers[index].destroy();
                    }

                    croppers[index] = new Cropper(item.image, {
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: true,
                        guides: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                    });

                    item.cropBtn.disabled = false;
                    item.resetBtn.disabled = false;
                    item.error.style.display = 'none';
                };

                reader.readAsDataURL(file);
            });

            item.cropBtn.addEventListener('click', function () {
                const cropper = croppers[index];
                if (!cropper) return;

                const croppedCanvas = cropper.getCroppedCanvas();
                if (!croppedCanvas) {
                    item.error.style.display = 'block';
                    return;
                }

                const base64Image = croppedCanvas.toDataURL();
                croppedImages[`image${index + 1}`] = base64Image;

                // Store cropped image in hidden input field
                document.getElementById(`image${index + 1}`).value = base64Image;

                // Show the cropped image preview below the crop button
                const previewContainer = document.getElementById(`previewContainer${index + 1}`);
                const previewImage = document.getElementById(`croppedPreview${index + 1}`);
                previewImage.src = base64Image;
                previewContainer.style.display = 'block';  // Show preview container
            });

            item.resetBtn.addEventListener('click', function () {
                croppers[index].reset();
                item.error.style.display = 'none';

                // Hide preview if reset is clicked
                const previewContainer = document.getElementById(`previewContainer${index + 1}`);
                previewContainer.style.display = 'none';
            });

            item.deleteBtn.addEventListener('click', function () {
                // Hide the image preview and the delete button
                item.image.style.display = 'none';
                item.deleteBtn.style.display = 'none';

                // Reset the cropper and remove the cropped image
                croppers[index].reset();
                item.error.style.display = 'none';

                // Optionally clear the hidden input field for the image
                document.getElementById(`image${index + 1}`).value = '';

                // Hide preview if delete is clicked
                const previewContainer = document.getElementById(`previewContainer${index + 1}`);
                previewContainer.style.display = 'none';
            });
        });

        // Form validation logic
        const form = document.getElementById('productForm');
        form.addEventListener('submit', function (e) {
            let valid = true;

            // Hide all previous error messages
            document.querySelectorAll('.error-message').forEach((el) => {
                el.style.display = 'none';
            });

            // Validate text fields (name, category, price, etc.)
            const fields = [
                { field: 'productName', error: 'productNameError' },
                { field: 'category', error: 'categoryError' },
                { field: 'price', error: 'priceError' },
                { field: 'brand', error: 'brandError' },
                { field: 'stock', error: 'stockError' },
                { field: 'color', error: 'colorError' },
                { field: 'material', error: 'materialError' },
                { field: 'productDescription', error: 'productDescriptionError' },
            ];

            fields.forEach((field) => {
                const input = document.getElementById(field.field);
                if (!input.value.trim()) {
                    document.getElementById(field.error).style.display = 'block';
                    valid = false;
                }
            });

            // Validate that at least one image has been uploaded
            if (!croppedImages.image1 && !croppedImages.image2 && !croppedImages.image3 && !croppedImages.image4) {
                imageUploads.forEach((item) => {
                    item.error.style.display = 'block';
                });
                valid = false;
            }

            if (!valid) {
                e.preventDefault();
            }
        });
    </script>
</body>

</html>